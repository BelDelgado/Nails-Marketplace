{% extends 'base.html' %}

{% block title %}Publicar Producto - Nails Marketplace{% endblock %}

{% block content %}
<section class="py-5 bg-light">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card border-0 shadow-lg">
                    <div class="card-header bg-primary text-white py-3">
                        <h3 class="mb-0">
                            <i class="fas fa-plus-circle me-2"></i>Publicar Nuevo Producto
                        </h3>
                    </div>
                    <div class="card-body p-4">
                        <form id="product-form" enctype="multipart/form-data">
                            <!-- Información Básica -->
                            <h5 class="mb-3">Información Básica</h5>
                            
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Título del Producto *</label>
                                <input type="text" id="title" class="form-control form-control-lg" 
                                       placeholder="Ej: Esmalte OPI Rojo Pasión" required>
                                <div class="form-text">Sé claro y descriptivo</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Descripción *</label>
                                <textarea id="description" class="form-control" rows="4" 
                                          placeholder="Describe tu producto: características, uso, estado..." required></textarea>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Categoría *</label>
                                    <select id="category" class="form-select" required>
                                        <option value="">Selecciona una categoría</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Precio (ARS) *</label>
                                    <input type="number" id="price" class="form-control" 
                                           placeholder="0.00" min="0" step="0.01" required>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">Stock *</label>
                                    <input type="number" id="stock" class="form-control" 
                                           value="1" min="1" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">Condición *</label>
                                    <select id="condition" class="form-select" required>
                                        <option value="new">Nuevo</option>
                                        <option value="like_new">Como nuevo</option>
                                        <option value="good">Buen estado</option>
                                        <option value="fair">Estado aceptable</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">Tipo *</label>
                                    <select id="product_type" class="form-select" required>
                                        <option value="sale">Venta</option>
                                        <option value="exchange">Intercambio</option>
                                        <option value="both">Venta/Intercambio</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Detalles Adicionales -->
                            <h5 class="mb-3 mt-4">Detalles Adicionales</h5>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Marca</label>
                                    <input type="text" id="brand" class="form-control" placeholder="OPI, Essie...">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Color</label>
                                    <input type="text" id="color" class="form-control" placeholder="Rojo, Rosa...">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Tamaño/Volumen</label>
                                    <input type="text" id="size" class="form-control" placeholder="15ml, 30ml...">
                                </div>
                            </div>
                            
                            <!-- Ubicación -->
                            <h5 class="mb-3 mt-4">Ubicación</h5>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Ciudad</label>
                                    <input type="text" id="city" class="form-control" placeholder="Buenos Aires">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Provincia</label>
                                    <input type="text" id="state" class="form-control" placeholder="CABA">
                                </div>
                            </div>
                            
                            <!-- Imágenes -->
                            <h5 class="mb-3 mt-4">Imágenes</h5>
                            
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Sube hasta 5 imágenes</label>
                                <input type="file" id="images" class="form-control" 
                                       accept="image/*" multiple>
                                <div class="form-text">Formatos: JPG, PNG. Máximo 2MB por imagen</div>
                            </div>
                            
                            <!-- Preview de imágenes -->
                            <div id="image-preview" class="row g-2 mb-3"></div>
                            
                            <!-- Botones -->
                            <div class="d-flex gap-2 mt-4">
                                <button type="submit" class="btn btn-primary btn-lg px-5">
                                    <i class="fas fa-check me-2"></i>Publicar Producto
                                </button>
                                <a href="/products/" class="btn btn-outline-secondary btn-lg">
                                    Cancelar
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<script>
// ==================== DEBUG ====================
console.log('=== SCRIPT CARGADO ===');

// Obtener CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');
console.log('CSRF Token:', csrftoken ? 'OK' : 'NO ENCONTRADO');

// Cargar categorías
async function loadCategories() {
    console.log('=== INICIANDO loadCategories() ===');
    
    try {
        console.log('Fetching /api/v1/categories/...');
        const response = await fetch('/api/v1/categories/');
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Datos recibidos:', data);
        
        // Manejar respuesta paginada o array directo
        let categories = [];
        if (Array.isArray(data)) {
            categories = data;
            console.log('Es un array directo');
        } else if (data.results && Array.isArray(data.results)) {
            categories = data.results;
            console.log('Es objeto con results, total:', data.count);
        }
        
        console.log('Categorías a procesar:', categories.length);
        
        const select = document.getElementById('category');
        console.log('Select element:', select);
        
        if (!select) {
            console.error('❌ NO SE ENCONTRÓ EL SELECT CON ID="category"');
            alert('ERROR: No se puede cargar las categorías (elemento select no encontrado)');
            return;
        }
        
        select.innerHTML = '<option value="">Selecciona una categoría</option>';
        console.log('Select limpiado');
        
        if (categories.length === 0) {
            console.warn('⚠️ No hay categorías disponibles');
            select.innerHTML = '<option value="">No hay categorías creadas</option>';
            return;
        }
        
        let contador = 0;
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.name;
            select.appendChild(option);
            contador++;
            console.log(`  ${contador}. Agregada: ${cat.name} (ID: ${cat.id})`);
        });
        
        console.log(`✅ ${contador} categorías agregadas exitosamente al select`);
        
    } catch (error) {
        console.error('❌ ERROR en loadCategories:', error);
        alert('Error al cargar categorías: ' + error.message);
        
        const select = document.getElementById('category');
        if (select) {
            select.innerHTML = '<option value="">Error al cargar categorías</option>';
        }
    }
}

// Preview de imágenes
document.getElementById('images').addEventListener('change', function(e) {
    console.log('=== Imágenes seleccionadas ===');
    const preview = document.getElementById('image-preview');
    preview.innerHTML = '';
    
    const files = Array.from(e.target.files);
    console.log('Total archivos:', files.length);
    
    if (files.length > 5) {
        alert('Máximo 5 imágenes permitidas');
        this.value = '';
        return;
    }
    
    files.forEach((file, index) => {
        console.log(`  Imagen ${index + 1}: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
        
        if (file.size > 5 * 1024 * 1024) {
            alert(`La imagen ${file.name} excede 5MB`);
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(event) {
            preview.innerHTML += `
                <div class="col-md-4 col-lg-3">
                    <div class="position-relative">
                        <img src="${event.target.result}" class="img-thumbnail" style="height: 150px; object-fit: cover;">
                        <span class="position-absolute top-0 start-0 m-2 badge bg-primary">
                            ${index === 0 ? 'Principal' : `Imagen ${index + 1}`}
                        </span>
                    </div>
                </div>
            `;
        };
        reader.readAsDataURL(file);
    });
});

// Enviar formulario
document.getElementById('product-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    console.log('=== ENVIANDO FORMULARIO ===');
    
    // Verificar autenticación
    const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
    console.log('Autenticado:', isAuthenticated);
    
    if (!isAuthenticated) {
        alert('Debes iniciar sesión para publicar productos');
        window.location.href = '{% url "account_login" %}?next={% url "product_create" %}';
        return;
    }
    
    // Validar campos
    const title = document.getElementById('title').value.trim();
    const description = document.getElementById('description').value.trim();
    const category = document.getElementById('category').value;
    const price = document.getElementById('price').value;
    const images = document.getElementById('images').files;
    
    console.log('Validando campos...');
    console.log('  Título:', title);
    console.log('  Descripción:', description ? description.substring(0, 50) + '...' : '(vacío)');
    console.log('  Categoría ID:', category);
    console.log('  Precio:', price);
    console.log('  Imágenes:', images.length);
    
    if (!title || !description || !category || !price) {
        alert('Por favor completa todos los campos obligatorios (*)');
        return;
    }
    
    if (images.length === 0) {
        alert('Debes subir al menos una imagen');
        return;
    }
    
    // Deshabilitar botón
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Publicando...';
    
    try {
        console.log('Creando FormData...');
        const formData = new FormData();
        formData.append('title', title);
        formData.append('description', description);
        formData.append('category', category);
        formData.append('price', price);
        formData.append('stock', document.getElementById('stock').value);
        formData.append('condition', document.getElementById('condition').value);
        formData.append('product_type', document.getElementById('product_type').value);
        formData.append('status', 'available');
        
        // Campos opcionales
        const brand = document.getElementById('brand').value.trim();
        const color = document.getElementById('color').value.trim();
        const size = document.getElementById('size').value.trim();
        const city = document.getElementById('city').value.trim();
        const state = document.getElementById('state').value.trim();
        
        if (brand) formData.append('brand', brand);
        if (color) formData.append('color', color);
        if (size) formData.append('size', size);
        if (city) formData.append('city', city);
        if (state) formData.append('state', state);
        
        // Agregar imágenes
        console.log('Agregando imágenes al FormData...');
        for (let i = 0; i < images.length && i < 5; i++) {
            formData.append('uploaded_images', images[i]);
            console.log(`  Imagen ${i + 1}: ${images[i].name}`);
        }
        
        console.log('Enviando POST a /api/v1/products/...');
        const response = await fetch('/api/v1/products/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
            },
            credentials: 'same-origin',
            body: formData
        });
        
        console.log('Response status:', response.status);
        
        if (response.ok) {
            const product = await response.json();
            console.log('✅ Producto creado:', product);
            alert('¡Producto publicado exitosamente!');
            window.location.href = `/products/${product.id}/`;
        } else {
            const errorData = await response.json();
            console.error('❌ Error del servidor:', errorData);
            
            let errorMsg = 'Error al publicar el producto:\n\n';
            for (let field in errorData) {
                if (Array.isArray(errorData[field])) {
                    errorMsg += `${field}: ${errorData[field].join(', ')}\n`;
                } else {
                    errorMsg += `${field}: ${errorData[field]}\n`;
                }
            }
            alert(errorMsg);
            
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    } catch (error) {
        console.error('❌ ERROR:', error);
        alert('Error al publicar el producto: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
});

// Inicializar
console.log('=== ESPERANDO DOM ===');
document.addEventListener('DOMContentLoaded', function() {
    console.log('✅ DOM CARGADO');
    console.log('Verificando elemento select...');
    
    const select = document.getElementById('category');
    if (select) {
        console.log('✓ Select encontrado:', select.tagName);
    } else {
        console.error('✗ Select NO encontrado');
    }
    
    console.log('Llamando a loadCategories()...');
    loadCategories();
    
    const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
    console.log('Estado de autenticación:', isAuthenticated);
});
</script>   
{% endblock %}